# אפיון מודול: תמיכה לחתונות יתומים

**מטרה:** מערכת לניהול בקשות תמיכה לחתונות יתומים — טופס חיצוני למילוי, ניהול תיקים פנימי למזכירות/מנהלים, תרגום אוטומטי לעברית/אנגלית, העלאת קבצים לאחר אישור, ניהול תשלומים וייצוא להעברות בנקאיות (MASAV).

---

## תקציר תהליך (High-level flow)
1. מילוי טופס בקשה חיצוני על ידי המשפחה (חתן/כלה). כולל שדות תאריך עברי/לועזי, פרטי החתונה, פרטי חתן/כלה ותעודות זהות.
2. לאחר שליחה — הטופס נכנס לטבלה `applicants` (טבלת גולמית). נשלח מייל למזכירות (Nodemailer).
3. מזכירות רואה את הבקשה ברשימת בקשות — יכולה לאשר/לדחות. אישור יוצר תיק (`case`) במערכת עם מספר רץ וסטטוס "חדש" או "בהמתנה לתורם" לפי הזרימה.
4. בתוך תיק: 4 טאבים — בקשה בעברית (עריכה אפשרית), בקשה באנגלית (כפתור "תרגם" שמשתמש ב-AI ושומר תוצאה ב-DB), מידע נוסף (העלאת קבצים — תמונה/PDF עד 5MB), תשלומים (היסטוריית תשלומים, המרת דולרים לש"ח, אישור להעברה).
5. כאשר מוזן סכום תרומה — סטטוס מתעדכן ל"נמצאה תרומה". לאחר אישור סכום להעברה — סטטוס ל"אושר להעברה". ביצוע ייצוא MASAV מסמן שהעברה נשלחה; לאחר קבלת אסמכתא הסכום בפועל והתאריך נשמרים והסטטוס הופך ל"הועבר".
6. דשבורד מרכזי עם לוח שנה עברי (ופילטר/חיפוש לפי לועזי), סטטיסטיקות חודשיות וסיכומים.
7. מודול העברות: טבלת העברות ממתינות וטבלת היסטוריה עם ייצוא/סינונים.

---

## משתמשים ותפקידים
- **מזכירות** — משתמש עיקרי: רואה בקשות, מאשר/דוחה, מעלה קבצים, מנהל העברות.
- **מנהלים** — גישה לצפייה/עריכה וסיכומים רחבים יותר.

> אין מערכת הרשאות מורכבת בשלב זה — שני סוגי משתמשים בלבד. משתמשים מאומתים דרך כניסה (Auth) ב-NextAuth או פתרון דומה.

---

## סטטוסים ותזרים סטטוסים (Status flow)
- `raw` (טופס גולמי, לא נוצר תיק)
- `new` (תיק נפתח — סטטוס ראשוני)
- `waiting_for_donor` (בהמתנה לתורם)
- `donation_found` (נמצאה תרומה)
- `approved_for_transfer` (אושר להעברה)
- `transfer_sent` (ייצוא MASAV בוצע)
- `transferred` (הועבר בפועל — אסמכתא נשמרת)
- `rejected` (נדחה)
- `expired` (עבר התאריך)

**המלצה:** שמירת היסטוריית שינויים (audit log) לכל סטטוס — מי שינה, מתי ומה הערות. זאת כטבלת `case_history` (זה חשוב לרישום ולבקרה).

---

## טבלאות בסיסיות (Postgres) — שורת סכימות
> חלק מהשדות מסומנים כ-`jsonb` כדי לאפשר שדות גמישים בעתיד.

### 1. applicants (הטופס החיצוני, גולמי)
- id (uuid, PK)
- created_at (timestamp)
- updated_at (timestamp)
- form_data (jsonb) — כל השדות הגולמיים במבנה גמיש
- email_sent_to_secretary (boolean)

### 2. cases (תיקים)
- id (uuid, PK)
- case_number (bigserial) — מספר רץ
- created_by (user_id)
- created_at, updated_at
- status (varchar)
- applicant_id (uuid) — קישור ל-applicants
- wedding_date_hebrew (date) — ניתן לשמור גם כמחרוזת אם רוצים
- wedding_date_gregorian (date)
- groom_first_name, groom_last_name, groom_id (varchar)
- bride_first_name, bride_last_name, bride_id
- venue, hall, guests_count, total_cost (numeric)
- contact_phone, contact_email
- raw_form_json (jsonb) — עותק גמיש של כל הפרטים

### 3. translations
- id
- case_id
- lang_from, lang_to
- content_json (jsonb) — שדות מתורגמים לפי מיפוי (שמור עריכה)
- translated_at, translated_by (user_id or 'ai')

### 4. files
- id
- case_id
- file_type (enum: menu, invitation, photo, thank_you_letter)
- filename
- path_or_url
- uploaded_by
- uploaded_at
- size_bytes

### 5. payments
- id
- case_id
- amount_israel_nis (numeric)
- amount_usd (numeric)
- exchange_rate_used (numeric)
- status (enum: pending, approved, exported, transferred)
- approved_amount (numeric)
- approved_by
- created_at
- transferred_at
- receipt_reference
- notes

### 6. transfers_export (MASAV exports)
- id
- exported_by
- exported_at
- filename
- csv_blob (bytea or ссылка)
- cases_included (jsonb - array of case ids)

### 7. users
- id, name, email, role (secretary/manager), password_hash

### 8. case_history (audit log)
- id
- case_id
- changed_by (user_id)
- field_changed
- old_value (text)
- new_value (text)
- changed_at
- note

---

## API Endpoints (Next.js API routes / REST suggestions)
> ניתן לממש GraphQL, אך REST פשוט מספיק כאן.

- `POST /api/applicants` — מקבל את הטופס החיצוני, שומר ב-applicants ושולח מייל למזכירות.
- `GET /api/applicants` — רשימת טפסים גולמיים (למזכירות).
- `POST /api/cases` — יצירת תיק מתוך applicant (מזכירות מאשרת)
- `GET /api/cases` — רשימת תיקים עם סינונים (status, month_hebrew, city, etc.)
- `GET /api/cases/:id` — טופס בעברית + מטה
- `PUT /api/cases/:id` — עדכון שדות בתיק
- `POST /api/cases/:id/translate` — קריאה ל-service AI -> שומר לטבלת translations
- `POST /api/cases/:id/files` — העלאת קבצים (אי.מגבלת 5MB)
- `GET /api/cases/:id/files` — רשימת קבצים
- `POST /api/cases/:id/payments` — יצירת/עדכון תשלום
- `POST /api/transfers/export` — ייצור קובץ MASAV מתוך payments מסומנים
- `GET /api/transfers` — רשימה היסטורית
- `POST /api/notifications/email` — ממשק פנימי לשליחת דוא"ל מותאם

---

## תרגום AI — שיטת עבודה
- כפתור "תרגם" ב־Tab 2 יקרא ל-API `POST /api/cases/:id/translate`.
- ה־API שולח payload רלוונטי לשירות AI (למשל OpenAI) עם המיפוי של השדות.
- התוצאה נשמרת בטבלת `translations` (content_json) וגם מועתקת ל־`cases` כעמודה `translated_form_en` אם המשתמש יאשר.
- שמירה ב־DB מונעת ריצות תרגום חוזרות.
- יש לאפשר עריכה ידנית של הטקסט המתורגם ולהשאיר דגל שמציין האם התרגום הוא סופי.

---

## קבצים והגבלות
- סוגים מותרים: `image/jpeg`, `image/png`, `application/pdf`.
- מגבלת גודל: 5MB לכל קובץ.
- אחסון: אפשרי על S3 או אחסון קבצים ב-Vercel / storage provider; מומלץ S3/MinIO עם URL מוחלט ב-DB.

---

## דשבורד ולוח שנה
- לוח שנה עברי כאלמנט מרכזי (הצגה לפי חודש עברי). בכל תא תופיע רשימת חתונות לאותו יום (שם החתן/כלה, מספר תיק, סטטוס קצר).
- חיפוש לפי תאריך עברי ולועזי שניהם (המרה פנימית/מיפוי בין תאריכים).
- סטטיסטיקות בצד: מספר חתונות בחודש, סכום עלויות כולל, סכומים שאושרו להעברה, סכומים שיוצאו להעברות.

---

## מודול העברות
- טבלה של העברות ממתינות (payments עם status=`approved_for_transfer` או דומה).
- טבלת היסטוריה של העברות עם פילטרים (תאריך, משפחה, סכום, מס' תיק, תורם).
- שדה להוספת פרטי בנק (במקום בטבלאות של המחאה), וניצוץ לייצוא MASAV בעזרת ספריית `masav`.
- לאחר ייצוא — מסומן `exported=true` ונשמר קובץ הייצוא.
- שליחת מייל סיכום עם הקובץ המצורף (Nodemailer).

---

## דואר אלקטרוני (Nodemailer)
- מיילים אוטומטיים: אישור קבלת טופס למזכירות, התראות סטטוס (אישור/דחייה), סיכום ייצוא MASAV עם קובץ מצורף.
- תצורת SMTP פשוטה (env variables עבור SMTP_HOST, SMTP_USER, SMTP_PASSWORD).

---

## UI / מסכים מרכזיים
1. **טופס חיצוני (Public)** — Next.js page, שדות כמו שפורטו (כולל ת"ז חתן וכלה). לאחר שליחה — הודעת תודה.
2. **רשימת בקשות** — טבלאות עם חיפוש/סינון; פעולות: צפייה, אישור, דחיה.
3. **תיק — מסך פירוט** — מעל: כפתורי סטטוס, מספר תיק, שם חתן/כלה ותאריך. מתחת: 4 טאבים (ע"פ תיאור).
4. **לוח שנה (דשבורד)** — תצוגה חודשית עברית + שורת סטטיסטיקות.
5. **מודול העברות** — טבלת העברות ממתינות וטבלת היסטוריה עם ייצוא.

---

## אבטחה ורגולציה
- שמירת תעודת זהות — נתון רגיש: יש לשקול הצפנה/הגנה מוגבלת בגישה (column-level encryption או encryption at rest).
- שימוש ב-HTTPS, סיסמאות/סשנים מאובטחים, rate-limit על endpoints ציבוריים.

---

## דרישות טכנולוגיות מוצעות
- Frontend: Next.js (React) — pages/app router לפי העדפה.
- Backend: Next.js API routes (או שירות Node.js נפרד) עם TypeORM/Prisma ל-Postgres.
- DB: PostgreSQL (with jsonb fields עבור גמישות).
- File storage: S3 (מומלץ).
- AI translation: OpenAI / שירות תרגום ממשקית.
- Email: Nodemailer.
- MASAV export: ספריית npm `masav` (כפי שביקשת).

---

## קבצי קלט/פלט לצוות פיתוח
- JSON schema של הטופס החיצוני.
- דוגמאות CSV לייצוא MASAV.
- דפי UI בפורמט Component tree (React).

---

## קבלת החלטות פתוחות (להבהרה בעת הפיתוח)
1. האם לשמור ת.ז. בפורמט גלוי או להצפין? (מומלץ להצפין).
2. היכן לאחסן קבצים — S3 מומלץ על Vercel storage.
3. האם להשתמש ב-NextAuth עם providers פנימיים או SSO? (לא דרוש כרגע).

---

## קריטריוני קבלה (Acceptance Criteria)
1. יכולת מילוי טופס חיצוני ושמירתו ב־DB ושליחת מייל למזכירות.
2. מזכירות יכולה לאשר/לדחות וליצור תיק עם מספר רץ.
3. בתיק: שמירה ועריכה של הבקשה בעברית; תרגום לעברית/אנגלית לשמירה ועריכה; העלאת קבצים עד 5MB.
4. ניהול תשלומים עם המרות דולרים לש"ח (כפתור המרה) והיסטוריית תשלומים.
5. יכולת לייצא MASAV ולשלוח מייל סיכום עם קובץ מצורף.
6. דשבורד עם לוח שנה עברי, חיפוש וסטטיסטיקות חודשיות.
7. שמירת היסטוריית שינויים (case_history) לכל תיק.

---

## שלבים מומלצים לפיתוח (MVP)
1. טופס חיצוני + שמירה ב-applicants + מייל למזכירות.
2. רשימת בקשות ואפשרות לאשר/לדחות — יצירת תיק בסיסי.
3. מסך תיק עם טאבים לשמירה/עדכון (עברית) + העלאת קבצים.
4. מודול תשלומים בסיסי + המרה מדולרים לש"ח.
5. ייצוא MASAV & מייל סיכום עם קובץ מצורף.
6. אינטגרציית AI לתרגום (כפתור "תרגם").
7. דשבורד ולוח שנה עברי.

---

### מודול שני: השתתפות בניקיון למשפחות עם ילד חולה

**מטרה:** מודול לניהול בקשות תמיכה בניקיון חודשי למשפחות עם ילד חולה — מילוי טופס חיצוני, פתיחת תיק אוטומטית, דיווח חודשי על הוצאות ניקיון עד לתקרה של 720 ש"ח לחודש, ניהול תשלומים וייצוא להעברה.

#### תהליך ודרישות עיקריות (כפי שענית):
1. טופס חיצוני למילוי — כולל שדות: ת.ז. הורים (אחד חובה), משפחה, שם הורה אב, שם הורה אם, שם ילד חולה, כתובת ועיר, 3 טלפונים, מייל, פרטי הבקשה, פרטי בנק ושם בעל החשבון.
2. לאחר שליחה — נשלח מייל למזכירה עם כל פרטי הטופס.
3. נפתח תיק **אוטומטית** במערכת (פעיל כברירת מחדל) — יתכן שחסרים שדות נוספים (כגון תוקף אושר עד איזה חודש).
4. בתיק יהיו:
   - טאב 1: פרטי הבקשה (עריכה אפשרית).
   - טאב 2: תשלומים (היסטוריית תשלומים חודשית).
5. יש שדה "אושר עד" (עד איזה חודש האישור תקף) — לא חובה למלא בשלב פתיחת התיק.
6. התמיכה היא לפי חודש — כל חודש המשפחה צריכה לדווח כמה עלה לה ניקיון (המגבלה לתקרה: 720 ש"ח לחודש). המזכירה תזין את הסכום בכל תיק ידנית; אופציה נוספת: טבלת מהירה למזכירה שבו היא בוחרת חודש וסכום לכל משפחה למתן זריזות.
7. שמירת כל היסטוריית התשלומים (לפי חודש) ותקציר בתיק שמציג סכום שהועבר עד היום.
8. יש כפתור לשנות מצב התיק ל"לא פעיל" עם סיבת סגירה (ילד הבריא / נפטר) — סטטוס פשוט: פעיל / לא פעיל.
9. ב-1 לחודש יש לשלח מייל לכל המשפחות ה"פעילות" עם בקשה לדווח בסכום החודשי; שורת הנושא של המייל תכלול את שם המשפחה. המשפחות ישיבו ידנית למייל.
10. במודול העברות — בעת ייצוא להעברות יהיו שני טאבים (יתומים / חולים). המזכירה תסמן וי (V) ליד משפחות/תיקים שרוצים להעביר כעת — הייצוא יכלול רק את המסומנים.

---

### שינויים ו־הרחבות במבנה הנתונים (DB)
- בעמודה `cases` להוסיף שדה `case_type` (enum: 'wedding', 'cleaning') כדי לאחד תיקים מסוגים שונים.
- להוסיף שדות רלוונטיים למודול הניקיון:
  - child_name
  - parent_id_number_primary (varchar)
  - parent_id_number_secondary (varchar, optional)
  - address, city
  - phone1, phone2, phone3
  - bank_details (jsonb) — {bank, branch, account_number, account_name}
  - approved_until (date or month-year) — לא חובה
  - active (boolean) — פעיל/לא פעיל
- payments טבלה: להוסיף שדה `payment_month` (date representing the month) ו־`payment_type` (enum: 'wedding_transfer', 'cleaning_monthly').
- להוסיף `cleaning_reports` או להשתמש ב־payments כדי לשמור גם דיווחים (כל דיווח חודשי יישמר כ־payment עם סטטוס 'reported' עד שאושר למעבר).

---

### Endpoints נוספים
- `POST /api/cleaning/applicants` — טופס חיצוני לניקיון (מזהה case_type='cleaning').
- `POST /api/cases/:id/cleaning/report` — להזנת דיווח חודשי (מזכירה או במערכת פנימית).
- `GET /api/cleaning/active` — רשימת משפחות פעילות (למייל החודשי).
- `POST /api/cleaning/send-monthly-request` — טריגר לשליחת המייל ב-1 לחודש (יכל להיות קרון או כפתור ידני במערכת; לפי תשובתך — יש כפתור להתחלה ידנית או שורה עליונה בדשבורד).
- `POST /api/transfers/export` — עדכון: לקבל payload עם רשימת case_ids מסומנים ולייצא רק את המסומנים; להוסיף פרמטר `case_type` כדי לייצא שני טאבים בנפרד.

---

### UI / מסכים
- בממשק תוסיף בתיק שורה עליונה עם סיכומים דומים לאלו של מודול היתומים (מס' תיק, סטטוס — פעיל/לא פעיל, שם הורה/משפחה, כפתור לאישור/דחייה וכו').
- מסך טבלה מהירה למזכירה להזנת תשלומים: בחירה של חודש, ובטבלה שורה לכל משפחה עם שדה סכום לעריכה ושדה V לבחירה לייצוא.
- בחלון העברות (Export) יש שני טאבים: "יתומים" ו"חולים"; כל טאב מציג את התיקים המוסמכים לייצוא עם סינון וסימון וי.

---

### דואר אלקטרוני חודשי
- אימייל ב-1 לחודש יוצא לכל המשפחות עם `active = true`.
- שורת נושא: "בקשה לדיווח חודשי - משפחת {FamilyName}".
- תוכן המייל ימנה בקשה לדווח כמה עלה הניקיון החודש; המשפחה תשיב ידנית למייל.
- כאשר המזכירה מקבלת תגובות — תהליך הזנת הסכומים ידני (מוזן לתוך התיק כ־payment/report).

---

### סגירת תיק - ניסוח כפתור
הצעתי כמה ניסוחים לבחירה (רגישים ומתאימים לשפה):
- "סגור - ילד הבריא" / "סגור - נפטר בע"ה" (או "נפטר")
- או ניסוח ניטרלי: "שנה סטטוס ל"לא פעיל" (בחר סיבה)" עם תיבת בחירה: [הבריא, נפטר, אחר]

ממליץ על האפשרות השנייה (ניטרלית) מהבחינה הפרקטית והרגישותית.

---

### קריטריונים נוספים וקווים מודולריים
- שכבות לוגיקה משותפות בין שני המודולים: שימוש ב־case_type כדי לאפשר דשבורד/סינון אחיד.
- שמירת תיעוד (case_history) גם כאן — מי שינה סטטוס, הוסיף סכום, שלח מייל, סגר תיק וכו'.

---

אם הכל נראה טוב — אעדכן את מסמך האפיון הראשי עם כל השינויים הללו (עשיתי כבר עדכון) ואכין:
1. ERD מעודכן הכולל שני סוגי תיקים.
2. דיאגרמת זרימה לעבודה החודשית (מייל חודשי → דיווחים → אישור מזכירה → ייצוא).
3. JSON schema לטופס ניקיון.

רוצה שאמשיך מיד ואייצר את ה־ERD וה־JSON schema?


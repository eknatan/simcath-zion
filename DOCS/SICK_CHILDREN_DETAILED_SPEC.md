# מסמך אפיון מפורט - מודול ניהול תיקי ילדים חולים

**תאריך:** נובמבר 2025
**גרסה:** 1.0
**סטטוס:** לאישור
**תחום:** סעיפים 3.2 - 3.4 מהאפיון המקורי

---

## תוכן עניינים

1. [סקירה כללית](#1-סקירה-כללית)
2. [תזרים עבודה (User Flow)](#2-תזרים-עבודה-user-flow)
3. [User Stories](#3-user-stories)
4. [מסכים ופיצ'רים](#4-מסכים-ופיצרים)
   - [4.1 דשבורד משפחות](#41-דשבורד-משפחות)
   - [4.2 מסך תיק - מבנה כללי](#42-מסך-תיק---מבנה-כללי)
   - [4.3 טאב פרטי הבקשה](#43-טאב-פרטי-הבקשה)
   - [4.4 טאב תשלומים חודשיים](#44-טאב-תשלומים-חודשיים)
   - [4.5 הזנה מהירה למספר משפחות](#45-הזנה-מהירה-למספר-משפחות)
   - [4.6 סגירת תיק](#46-סגירת-תיק)
   - [4.7 דשבורד משפחות לא פעילות](#47-דשבורד-משפחות-לא-פעילות)
   - [4.8 שליחת מיילים חודשיים](#48-שליחת-מיילים-חודשיים)
5. [Validation Rules](#5-validation-rules)
6. [Edge Cases & Error Handling](#6-edge-cases--error-handling)
7. [אינטגרציה עם מודולים קיימים](#7-אינטגרציה-עם-מודולים-קיימים)
8. [הגדרות מערכת](#8-הגדרות-מערכת)
9. [Data Model](#9-data-model)

---

## 1. סקירה כללית

### 1.1 מטרה
מודול ניהול תיקי ילדים חולים מאפשר למזכירות לנהל תמיכה חודשית למשפחות עם ילד חולה.
התמיכה היא בצורה של תשלום חודשי לניקיון הבית (עד 720 ₪ לחודש).

### 1.2 הבדלים מתיקי חתונות

| תכונה | חתונות | ילדים חולים |
|-------|---------|-------------|
| **פתיחת תיק** | דרישת אישור מזכירה | אוטומטית |
| **טאבים בתיק** | 4 (פרטים, תרגום, קבצים, תשלומים) | 2 (פרטים, תשלומים) |
| **תשלומים** | חד פעמי | חודשיים חוזרים |
| **סטטוס תיק** | חדש → ממתין → הועבר → נדחה/פג תוקף | פעיל / לא פעיל |
| **דשבורד** | לוח שנה עברי + סטטיסטיקות | טבלה פשוטה |

### 1.3 נתיב ניווט במערכת

```
Navbar → "תיקים"
  ├── טאב "חתונות" (קיים)
  └── טאב "ילדים חולים" ← **דשבורד משפחות החדש**
      ├── רשימת משפחות פעילות (טבלה)
      ├── כפתור "הזנה מהירה"
      └── כפתור "משפחות לא פעילות" → דף נפרד
```

---

## 2. תזרים עבודה (User Flow)

### תרחיש 1: משפחה חדשה נרשמת

```
1. משפחה ממלאת טופס ציבורי (/public-forms/sick-children)
   ↓
2. מערכת יוצרת applicant + case אוטומטית (status = 'active')
   ↓
3. מייל נשלח למזכירות: "נוספה משפחה חדשה - משפחת [שם]"
   ↓
4. מזכירה רואה את המשפחה בדשבורד "ילדים חולים"
   ↓
5. לוחצת על שם המשפחה → נכנסת למסך התיק
```

### תרחיש 2: הזנת תשלום חודשי יחיד

```
1. מזכירה נכנסת לתיק ספציפי
   ↓
2. טאב "תשלומים חודשיים"
   ↓
3. בוחרת חודש מ-dropdown (ינואר 2025)
   ↓
4. מזינה סכום (650 ₪)
   ↓
5. לוחצת "שמור והעבר לתשלום"
   ↓
6. תשלום נוסף ל-DB (status = 'pending')
   ↓
7. תשלום מועבר למודול העברות (טאב "ילדים חולים")
```

### תרחיש 3: הזנה מהירה למספר משפחות

```
1. מזכירה בדשבורד "ילדים חולים"
   ↓
2. לוחצת על "הזנה מהירה"
   ↓
3. נפתח modal/דף עם:
   - בחירת חודש (דצמבר 2024)
   - טבלה של משפחות פעילות שעוד לא קיבלו תשלום לחודש זה
   ↓
4. מזכירה מזינה סכום בשורה של כל משפחה (720, 650, 500...)
   ↓
5. לוחצת "העבר הכל לתשלום"
   ↓
6. רק משפחות עם סכום > 0 נשמרות ועוברות למודול העברות
```

### תרחיש 4: שליחת מיילים חודשיים

```
1. מזכירה בדשבורד "ילדים חולים"
   ↓
2. לוחצת על "שלח מיילים חודשיים"
   ↓
3. דיאלוג: "לשלוח לכל המשפחות הפעילות או לבחור?"
   ↓
4. אם בחירה → modal עם checkboxes של כל משפחה
   ↓
5. אם יש משפחות שכבר קיבלו מייל החודש → אזהרה
   ↓
6. מסך תצוגה מקדימה + עריכת תבנית
   ↓
7. אישור סופי ("האם אתה בטוח?")
   ↓
8. שליחה + רישום ב-email_logs
```

---

## 3. User Stories

### US-1: צפייה ברשימת משפחות פעילות
**בתור** מזכירה
**אני רוצה** לראות רשימה של כל המשפחות הפעילות
**כדי** לעקוב אחרי התשלומים החודשיים

**Acceptance Criteria:**
- רשימה מציגה רק משפחות עם `status = 'active'`
- עמודות: שם משפחה, שם ילד, תאריך התחלה, סכום חודש נוכחי, סטטוס תשלום
- סינון לפי: עיר, חודש, סטטוס תשלום
- משפחות ללא תשלום מ-15 לחודש מסומנות ברקע אדום בהיר
- לחיצה על שורה → פותח מסך תיק

---

### US-2: הזנת תשלום חודשי בודד
**בתור** מזכירה
**אני רוצה** להזין תשלום חודשי למשפחה ספציפית
**כדי** לתעד את התמיכה שהם מקבלים

**Acceptance Criteria:**
- בחירת חודש/שנה מ-dropdown
- הזנת סכום (עד 720 ₪)
- אזהרה אם סכום > 720 ₪ אבל אפשר לאשר
- אזהרה אם כבר קיים תשלום לחודש זה
- כפתור "שמור והעבר לתשלום"
- תשלום נשמר ב-DB ומועבר למודול העברות

---

### US-3: הזנה מהירה למספר משפחות
**בתור** מזכירה
**אני רוצה** להזין תשלומים למספר משפחות בבת אחת
**כדי** לחסוך זמן בתחילת כל חודש

**Acceptance Criteria:**
- בחירת חודש אחד לכל המשפחות
- טבלה מציגה רק משפחות פעילות שעוד לא קיבלו תשלום לחודש זה
- משפחות שכבר קיבלו מסומנות "כבר קיבל החודש"
- הזנת סכום שונה לכל משפחה
- משפחות ללא סכום לא נכללות בהעברה
- כפתור "העבר הכל לתשלום"

---

### US-4: שליחת מיילים חודשיים
**בתור** מזכירה
**אני רוצה** לשלוח מיילים לכל המשפחות הפעילות
**כדי** לבקש מהם לדווח על עלות הניקיון

**Acceptance Criteria:**
- אפשרות לשלוח לכולם או לבחור משפחות ספציפיות
- עריכת תבנית המייל לפני שליחה
- תצוגה מקדימה
- אזהרה אם משפחות כבר קיבלו מייל החודש
- אישור סופי לפני שליחה
- רישום ב-email_logs
- תמיכה בעברית ואנגלית

---

### US-5: סגירת תיק
**בתור** מזכירה
**אני רוצה** לסגור תיק של משפחה
**כדי** להפסיק תמיכה (כשהילד החלים או במקרים אחרים)

**Acceptance Criteria:**
- כפתור "סגור תיק" במסך התיק
- בחירת סיבה: החלים / נפטר / אחר (טקסט חופשי)
- אזהרה אם יש תשלומים ממתינים
- אישור סופי ("האם אתה בטוח?")
- סטטוס עובר ל-`'inactive'`, נשמר תאריך סגירה + סיבה
- תשלומים ממתינים נשארים בטבלת העברות

---

### US-6: פתיחה מחדש של תיק
**בתור** מזכירה
**אני רוצה** לפתוח מחדש תיק סגור
**כדי** לתקן טעות או להחזיר משפחה לתמיכה

**Acceptance Criteria:**
- כפתור "החזר לפעיל" במסך תיק לא פעיל
- סטטוס חוזר ל-`'active'`
- `end_date` ו-`end_reason` נמחקים
- נשמר לוג של הפעולה ב-`case_history`

---

## 4. מסכים ופיצ'רים

### 4.1 דשבורד משפחות

**נתיב:** `/cases` (טאב "ילדים חולים")

#### Layout

```
┌────────────────────────────────────────────────────────────┐
│ תיקים                                                       │
│ [טאב: חתונות] [טאב: ילדים חולים*]                          │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  [🔍 חיפוש...]  [סינון: עיר ▼] [סינון: סטטוס תשלום ▼]    │
│                                                            │
│  [➕ הזנה מהירה]              [📋 משפחות לא פעילות]        │
│                                                            │
├────────────────────────────────────────────────────────────┤
│ טבלת משפחות פעילות                                         │
├─────────┬──────────┬────────────┬─────────────┬───────────┤
│ שם      │ שם ילד   │ תאריך      │ סכום חודש  │ סטטוס     │
│ משפחה   │ חולה     │ התחלה      │ נוכחי      │ תשלום     │
├─────────┼──────────┼────────────┼─────────────┼───────────┤
│ כהן     │ יוסי     │ 01/2024    │ 720 ₪      │ ✅ הועבר  │
│ לוי     │ שרה      │ 03/2024    │ -          │ ⏳ ממתין   │ ← רקע אדום בהיר (אם אחרי ה-15)
│ דוד     │ משה      │ 05/2024    │ 650 ₪      │ ⏳ ממתין   │
└─────────┴──────────┴────────────┴─────────────┴───────────┘
│                                                            │
│ סה"כ משפחות פעילות: 3                                      │
└────────────────────────────────────────────────────────────┘
```

#### פונקציונליות

**כפתורים:**
1. **"הזנה מהירה"** → פותח modal/דף (ראה סעיף 4.5)
2. **"משפחות לא פעילות"** → ניווט ל-`/cases/inactive` (ראה סעיף 4.7)

**טבלה:**
- **שם משפחה:** קישור למסך התיק (`/cases/[id]`)
- **שם ילד חולה:** טקסט
- **תאריך התחלה:** פורמט `MM/YYYY`
- **סכום חודש נוכחי:**
  - אם יש תשלום לחודש הנוכחי → מציג סכום
  - אם אין → מציג "-"
- **סטטוס תשלום:**
  - ✅ "הועבר" (ירוק)
  - ⏳ "ממתין להעברה" (כתום)
  - "-" (אין תשלום)

**אינדיקטור חזותי:**
- מ-15 בחודש ואילך: שורות ללא תשלום מסומנות ברקע **אדום בהיר** (`bg-red-50`)

**סינונים:**
- חיפוש טקסט: שם משפחה / שם ילד
- סינון לפי עיר
- סינון לפי סטטוס תשלום (הועבר / ממתין / אין)

---

### 4.2 מסך תיק - מבנה כללי

**נתיב:** `/cases/[id]`

#### Layout

```
┌────────────────────────────────────────────────────────────┐
│ תיק מס' 2451 - משפחת כהן                                   │
│                                                            │
│ סטטוס: [פעיל ▼]    תאריך התחלה: 01/2024                   │
│ שם ילד: יוסי כהן   סה"כ הועבר: 8,640 ₪ (12 חודשים)       │
│                                                            │
│ [🔒 סגור תיק]                                              │
├────────────────────────────────────────────────────────────┤
│ [טאב: פרטי הבקשה*] [טאב: תשלומים חודשיים]                 │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  (תוכן הטאב)                                               │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

#### רצועת מידע עליונה (Header)

**שדות:**
- **מס' תיק:** `case_number`
- **שם משפחה:** `family_name`
- **שם ילד:** `child_name`
- **סטטוס:** dropdown (פעיל / לא פעיל) - שינוי ידני
- **תאריך התחלה:** `start_date` (פורמט MM/YYYY)
- **סה"כ הועבר:** סכום כולל של כל התשלומים ש-`status = 'transferred'`
- **מספר חודשים:** ספירה של תשלומים שהועברו

**כפתורים:**
- **"סגור תיק"** → פותח דיאלוג סגירה (ראה סעיף 4.6)

---

### 4.3 טאב פרטי הבקשה

**מטרה:** הצגת כל הפרטים מהטופס המקורי (read-only או עריכה מוגבלת)

#### Layout

```
┌────────────────────────────────────────────────────────────┐
│ פרטי המשפחה                                                │
├────────────────────────────────────────────────────────────┤
│                                                            │
│ 👨‍👩‍👧‍👦 פרטי משפחה                                             │
│   שם משפחה: כהן                                            │
│   שם ילד חולה: יוסי                                        │
│   הורה 1: אברהם כהן (ת.ז. 123456789)                       │
│   הורה 2: שרה כהן (ת.ז. 987654321)                         │
│                                                            │
│ 📍 פרטי קשר                                                │
│   כתובת: רחוב המלאכים 7, פתח תקווה                         │
│   טלפון 1: 052-1111111                                     │
│   טלפון 2: 052-2222222                                     │
│   מייל: cohen@example.com                                  │
│                                                            │
│ 🏦 פרטי בנק                                                │
│   בנק: 10 (בנק לאומי)                                      │
│   סניף: 123                                                │
│   חשבון: 1234567                                           │
│   שם בעל החשבון: אברהם כהן                                 │
│                                                            │
│ 📅 תקציר תיק                                               │
│   תאריך התחלה: ינואר 2024                                  │
│   תאריך סיום: -                                            │
│   מספר חודשים פעילים: 11                                   │
│   סה"כ הועבר: 7,920 ₪                                      │
│                                                            │
│ 📧 מעקב מיילים                                             │
│   מייל אחרון נשלח: 05/11/2024                              │
│                                                            │
│ [💾 שמור שינויים]                                          │
└────────────────────────────────────────────────────────────┘
```

#### פונקציונליות

**שדות ניתנים לעריכה:**
- כל השדות מהטופס המקורי
- שמירה אוטומטית או כפתור "שמור שינויים"

**שדות read-only:**
- תקציר תיק (מחושב אוטומטית)
- מעקב מיילים (מחושב אוטומטית)

---

### 4.4 טאב תשלומים חודשיים

**מטרה:** הזנת תשלומים חודשיים + היסטוריה

#### Layout - חלק עליון (הזנה חדשה)

```
┌────────────────────────────────────────────────────────────┐
│ הזנת תשלום חודשי חדש                                       │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  חודש: [בחר חודש ▼]  שנה: [2024 ▼]                        │
│                                                            │
│  סכום (₪): [______]  (תקרה: 720 ₪)                        │
│                                                            │
│  הערות: [________________________]                         │
│                                                            │
│  [💾 שמור והעבר לתשלום]                                    │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

#### Layout - חלק תחתון (היסטוריה)

```
┌────────────────────────────────────────────────────────────┐
│ היסטוריית תשלומים                                          │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  [🔍 סינון לפי שנה: 2024 ▼]  [📊 ייצא ל-Excel]            │
│                                                            │
├────────┬──────┬──────────┬──────────────┬────────┬────────┤
│ חודש   │ שנה  │ סכום (₪)│ תאריך הזנה   │ סטטוס  │ פעולות│
├────────┼──────┼──────────┼──────────────┼────────┼────────┤
│ נובמבר │ 2024 │ 720      │ 05/11/2024   │ ✅ הועבר│ 🗑️ ✏️ │
│ אוקטובר│ 2024 │ 650      │ 02/10/2024   │ ⏳ ממתין│ 🗑️ ✏️ │
│ ספטמבר │ 2024 │ 720      │ 01/09/2024   │ ✅ הועבר│ 🗑️ ✏️ │
│ אוגוסט │ 2024 │ 700      │ 05/08/2024   │ ✅ הועבר│ 🗑️ ✏️ │
└────────┴──────┴──────────┴──────────────┴────────┴────────┘
│                                                            │
│ סה"כ שנה זו: 2,790 ₪                                       │
└────────────────────────────────────────────────────────────┘
```

#### פונקציונליות - הזנת תשלום חדש

**שדות:**
1. **חודש:** dropdown (ינואר, פברואר, ..., דצמבר)
2. **שנה:** dropdown (2024, 2025, ...)
3. **סכום:** input number (עד 720 ₪)
4. **הערות:** textarea (אופציונלי)

**Validation:**
- אם `סכום > 720`: הצגת אזהרה "⚠️ הסכום עולה על התקרה המאושרת (720 ₪). האם להמשיך?"
  - אפשרויות: [ביטול] [אשר בכל זאת]
- אם כבר קיים תשלום לחודש+שנה זה:
  - אזהרה: "⚠️ כבר קיים תשלום לחודש זה. האם לערוך את התשלום הקיים?"
  - אפשרויות: [ביטול] [עריכה]

**פעולה:**
- לחיצה על "שמור והעבר לתשלום":
  1. שמירה ב-`payments` עם:
     - `case_id`
     - `payment_type = 'cleaning_monthly'`
     - `payment_month` (תאריך של יום 1 בחודש)
     - `amount_ils`
     - `status = 'pending'`
  2. העברה למודול העברות (טאב "ילדים חולים")
  3. הצגת הודעת הצלחה: "✅ תשלום נשמר והועבר לטבלת העברות"

#### פונקציונליות - היסטוריה

**עמודות:**
- **חודש:** שם החודש בעברית
- **שנה:** ארבע ספרות
- **סכום (₪):** עם פסיק אלפים
- **תאריך הזנה:** `created_at` (פורמט DD/MM/YYYY)
- **סטטוס:**
  - ✅ "הועבר" (ירוק)
  - ⏳ "ממתין להעברה" (כתום)
  - ❌ "בוטל" (אפור)
- **פעולות:**
  - 🗑️ מחיקה (רק אם `status = 'pending'`)
  - ✏️ עריכה (רק אם `status = 'pending'`)

**סינונים:**
- סינון לפי שנה
- ייצוא ל-Excel (כל ההיסטוריה או מסונן)

---

### 4.5 הזנה מהירה למספר משפחות

**טריגר:** כפתור "הזנה מהירה" בדשבורד ילדים חולים

**מימוש:** Modal מלא מסך או דף נפרד (`/cases/bulk-entry`)

#### Layout

```
┌────────────────────────────────────────────────────────────┐
│ הזנה מהירה - תשלומים חודשיים                               │
│                                                    [✕ סגור] │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  בחר חודש: [נובמבר ▼]  שנה: [2024 ▼]                      │
│                                                            │
│  [🔍 חיפוש משפחה...]                                       │
│                                                            │
├───────────────┬──────────┬──────────────┬─────────────────┤
│ שם משפחה      │ שם ילד   │ טלפון        │ סכום (₪)       │
├───────────────┼──────────┼──────────────┼─────────────────┤
│ כהן           │ יוסי     │ 052-1111111  │ [720_____]      │
│ לוי           │ שרה      │ 052-2222222  │ [650_____]      │
│ דוד ⚠️ כבר קיבל│ משה      │ 052-3333333  │ [________] ✅   │
│ מזרחי         │ דוד      │ 052-4444444  │ [________]      │
└───────────────┴──────────┴──────────────┴─────────────────┘
│                                                            │
│  סה"כ נבחרו: 2 משפחות | סה"כ לתשלום: 1,370 ₪            │
│                                                            │
│  [ביטול]                         [💾 העבר הכל לתשלום]     │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

#### פונקציונליות

**בחירת חודש:**
- dropdown של חודש + שנה
- ברגע שנבחר → טעינת הטבלה

**טבלה:**
- **מציגה רק משפחות פעילות** (`status = 'active'`)
- **משפחות שכבר קיבלו תשלום לחודש זה:**
  - מסומנות בטקסט אפור + אינדיקטור "⚠️ כבר קיבל החודש"
  - עדיין מופיעות ברשימה (למקרה שצריך לתקן)
- **שדה סכום:**
  - input number
  - אם מזינים סכום > 0 → המשפחה **אוטומטית נספרת** כנבחרת
  - אם משאירים ריק → לא נכללת בהעברה

**Validation:**
- אם סכום > 720: אזהרה בצד השדה (אבל לא חוסם)
- אם אף משפחה לא נבחרה (כולם ריקים): "⚠️ לא נבחרו משפחות"

**פעולה:**
- לחיצה על "העבר הכל לתשלום":
  1. שמירה ב-`payments` לכל משפחה עם סכום > 0
  2. העברה למודול העברות (טאב "ילדים חולים")
  3. הצגת הודעה: "✅ 2 תשלומים נשמרו והועברו לטבלת העברות (סה"כ 1,370 ₪)"
  4. סגירת המודל

---

### 4.6 סגירת תיק

**טריגר:** כפתור "סגור תיק" במסך התיק (רצועה עליונה)

#### Layout - דיאלוג סגירה

```
┌────────────────────────────────────────────────────────────┐
│ סגירת תיק - משפחת כהן                                      │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ⚠️ האם אתה בטוח שברצונך לסגור את התיק?                   │
│                                                            │
│  בחר סיבת סגירה:                                           │
│                                                            │
│  ○ ✅ הילד החלים (ברוך השם)                                │
│  ○ ❌ לצערנו הילד נפטר                                     │
│  ○ ⏸ סיום תמיכה (סיבה אחרת)                               │
│                                                            │
│  הסבר נוסף (אופציונלי):                                    │
│  [_________________________________]                       │
│                                                            │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ⚠️ שים לב: קיים תשלום ממתין להעברה לחודש נובמבר (720 ₪)  │
│  התשלום יישאר בטבלת העברות.                               │
│                                                            │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  [ביטול]                                      [✓ אשר סגירה]│
│                                                            │
└────────────────────────────────────────────────────────────┘
```

#### פונקציונליות

**Validation:**
- אם יש תשלומים עם `status = 'pending'`:
  - הצגת אזהרה (אבל לא חוסם)
  - "⚠️ קיים תשלום ממתין להעברה לחודש X (סכום ₪). התשלום יישאר בטבלת העברות."

**פעולה:**
1. שמירה ב-`cases`:
   - `status = 'inactive'`
   - `end_date = NOW()`
   - `end_reason = 'healed' | 'deceased' | 'other'`
2. אם נבחר "סיבה אחרת" + טקסט חופשי → שמירה בשדה `end_reason_notes`
3. רישום ב-`case_history`:
   - `field_changed = 'status'`
   - `old_value = 'active'`
   - `new_value = 'inactive'`
   - `note = [סיבת סגירה]`
4. סגירת הדיאלוג
5. ניווט חזרה לדשבורד או הצגת מסך התיק (עם אינדיקטור "לא פעיל")

---

### 4.7 דשבורד משפחות לא פעילות

**נתיב:** `/cases/inactive` או טאב בתוך `/cases`

**טריגר:** כפתור "משפחות לא פעילות" בדשבורד ילדים חולים

#### Layout

```
┌────────────────────────────────────────────────────────────┐
│ משפחות לא פעילות                                           │
│                                                            │
│  [🔍 חיפוש...]  [סינון: סיבת סגירה ▼] [חזור לפעילות]     │
│                                                            │
├─────────┬──────────┬────────────┬─────────────┬───────────┤
│ שם      │ שם ילד   │ תאריך      │ תאריך       │ סיבת      │
│ משפחה   │          │ התחלה      │ סגירה       │ סגירה     │
├─────────┼──────────┼────────────┼─────────────┼───────────┤
│ אבוטבול │ דניאל    │ 01/2023    │ 15/10/2024  │ ✅ החלים  │
│ ברוך    │ יעקב     │ 05/2022    │ 01/08/2024  │ ❌ נפטר   │
│ גולן    │ שמעון    │ 03/2024    │ 20/11/2024  │ ⏸ אחר     │
└─────────┴──────────┴────────────┴─────────────┴───────────┘
│                                                            │
│ סה"כ תיקים לא פעילים: 3                                    │
└────────────────────────────────────────────────────────────┘
```

#### פונקציונליות

**טבלה:**
- מציגה רק `cases` עם `status = 'inactive'`
- לחיצה על שורה → פותח מסך התיק

**מסך תיק לא פעיל:**
- זהה לתיק רגיל, אבל:
  - **אינדיקטור "לא פעיל"** ברצועה עליונה
  - **כפתור "החזר לפעיל"** במקום "סגור תיק"

**כפתור "החזר לפעיל":**
1. דיאלוג אישור: "האם אתה בטוח שברצונך להחזיר את התיק לסטטוס פעיל?"
2. פעולה:
   - `status = 'active'`
   - `end_date = NULL`
   - `end_reason = NULL`
   - רישום ב-`case_history`

---

### 4.8 שליחת מיילים חודשיים

**טריגר:** כפתור "שלח מיילים חודשיים" בדשבורד ילדים חולים

#### תהליך מלא (Flow)

##### שלב 1: בחירת נמענים

```
┌────────────────────────────────────────────────────────────┐
│ שליחת מיילים חודשיים                                       │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  האם לשלוח לכל המשפחות הפעילות?                            │
│                                                            │
│  [📧 שלח לכולם (15 משפחות)]  [📝 בחר משפחות ספציפיות]     │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

**אם נבחר "בחר משפחות ספציפיות":**

```
┌────────────────────────────────────────────────────────────┐
│ בחירת משפחות                                               │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  [✓ בחר הכל]  [✗ בטל הכל]  [🔍 חיפוש...]                  │
│                                                            │
│  ☑ משפחת כהן (cohen@example.com)                           │
│  ☑ משפחת לוי (levi@example.com) ⚠️ מייל נשלח ב-05/11      │
│  ☐ משפחת דוד (david@example.com)                           │
│  ☑ משפחת מזרחי (mizrahi@example.com)                       │
│                                                            │
│  סה"כ נבחרו: 3 משפחות                                      │
│                                                            │
│  ⚠️ 1 משפחה כבר קיבלה מייל החודש. האם לשלוח שוב?          │
│  [כן, שלח שוב] [דלג על משפחות שקיבלו]                      │
│                                                            │
│  [ביטול]                                          [הבא →]  │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

##### שלב 2: עריכת תבנית + תצוגה מקדימה

```
┌────────────────────────────────────────────────────────────┐
│ תבנית המייל                                                │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  שפה: ○ עברית  ○ English                                  │
│                                                            │
│  נושא:                                                     │
│  [דיווח ניקיון לחודש {month} - משפחת {family_name}]       │
│                                                            │
│  גוף המייל:                                                │
│  ┌────────────────────────────────────────────────────────┐│
│  │ שלום הורים יקרים,                                     ││
│  │                                                        ││
│  │ בתחילת כל חודש אנו מבקשים ממך לדווח כמה עלה לך        ││
│  │ ניקיון ביתך.                                           ││
│  │                                                        ││
│  │ כמות מאושרת: עד 720 ₪                                 ││
│  │                                                        ││
│  │                                                        ││
│  │ אנא הגב במייל חוזר עם הסכום המדויק.                   ││
│  │                                                        ││
│  │ בברכה,                                                 ││
│  │ עמותת שמחת ציון                                        ││
│  │                                                        ││
│  │ [לוגו העמותה]                                          ││
│  └────────────────────────────────────────────────────────┘│
│                                                            │
│  משתנים זמינים: {family_name}, {child_name}, {month}      │
│                                                            │
│  [👁️ תצוגה מקדימה]                                        │
│                                                            │
│  [← חזור]                                    [שלח מיילים →]│
│                                                            │
└────────────────────────────────────────────────────────────┘
```

##### שלב 3: אישור סופי

```
┌────────────────────────────────────────────────────────────┐
│ אישור שליחה                                                │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ⚠️ האם אתה בטוח שברצונך לשלוח מיילים ל-3 משפחות?         │
│                                                            │
│  הפעולה תשלח:                                              │
│  • 3 מיילים לכתובות שונות                                  │
│  • נושא: "דיווח ניקיון לחודש נובמבר - משפחת..."           │
│  • שפה: עברית                                              │
│                                                            │
│  [ביטול]                                      [✓ שלח עכשיו] │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

##### שלב 4: תוצאה

```
┌────────────────────────────────────────────────────────────┐
│ ✅ מיילים נשלחו בהצלחה!                                    │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  נשלחו 3 מיילים:                                           │
│  ✓ משפחת כהן                                               │
│  ✓ משפחת לוי                                               │
│  ✓ משפחת מזרחי                                             │
│                                                            │
│  תאריך שליחה: 20/11/2024 14:35                             │
│                                                            │
│  [סגור]                                  [צפה ברשימה מלאה] │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

#### תבנית מייל - תמיכה דו-לשונית

**עברית:**
```
נושא: דיווח ניקיון לחודש {month} - משפחת {family_name}

שלום הורים יקרים,

בתחילת כל חודש אנו מבקשים ממך לדווח כמה עלה לך ניקיון ביתך.

כמות מאושרת: עד 720 ₪

אנא הגב במייל חוזר עם הסכום המדויק.

בברכה,
עמותת שמחת ציון
```

**English:**
```
Subject: Cleaning Report for {month} - {family_name} Family

Dear Parents,

At the beginning of each month, we ask you to report the cost of cleaning your home.

Approved amount: up to 720 ₪

Please reply to this email with the exact amount.

Best regards,
Simchat Zion Foundation
```

#### Validation & Edge Cases

**מניעת שליחה כפולה:**
- שאילתה ל-`email_logs`:
  ```sql
  SELECT * FROM email_logs
  WHERE case_id = X
    AND email_type = 'monthly_request'
    AND sent_at >= DATE_TRUNC('month', NOW())
  ```
- אם נמצא → הצגת אזהרה במסך בחירת משפחות

**כשלון בשליחה:**
- אם מייל נכשל (SMTP error):
  - רישום ב-`email_logs` עם `status = 'failed'`
  - הצגת הודעה: "❌ שגיאה בשליחת מייל למשפחת X"
  - המשך שליחה לשאר המשפחות

---

## 5. Validation Rules

### 5.1 הזנת תשלום חודשי

| שדה | Validation | הודעת שגיאה |
|-----|-----------|------------|
| **חודש** | Required | "יש לבחור חודש" |
| **שנה** | Required | "יש לבחור שנה" |
| **סכום** | Required, > 0 | "יש להזין סכום גדול מ-0" |
| **סכום** | אזהרה אם > 720 | "הסכום עולה על התקרה (720 ₪)" |
| **תשלום כפול** | אזהרה אם קיים | "כבר קיים תשלום לחודש זה" |

### 5.2 הזנה מהירה

| תנאי | Validation | הודעת שגיאה |
|------|-----------|------------|
| **אף משפחה לא נבחרה** | סכום > 0 לפחות למשפחה אחת | "לא נבחרו משפחות לתשלום" |
| **סכום שלילי** | חסימה | "סכום לא יכול להיות שלילי" |

### 5.3 סגירת תיק

| שדה | Validation | הודעת שגיאה |
|-----|-----------|------------|
| **סיבת סגירה** | Required | "יש לבחור סיבת סגירה" |
| **הסבר נוסף** | Required אם "סיבה אחרת" | "יש להזין הסבר לסגירה" |

### 5.4 שליחת מיילים

| תנאי | Validation | הודעת שגיאה |
|------|-----------|------------|
| **אין משפחות פעילות** | מניעה | "אין משפחות פעילות במערכת" |
| **אין מייל למשפחה** | דילוג + אזהרה | "משפחת X ללא כתובת מייל - דולגים" |
| **כתובת מייל לא תקינה** | דילוג + אזהרה | "כתובת מייל לא תקינה למשפחת X" |

---

## 6. Edge Cases & Error Handling

### 6.1 תשלום לחודש עתידי
**תרחיש:** מזכירה מזינה תשלום לחודש שעוד לא הגיע (למשל דצמבר 2025 ואנחנו בנובמבר 2024)

**טיפול:**
- אזהרה: "⚠️ החודש שנבחר הוא בעתיד. האם להמשיך?"
- אפשר לאשר (לא חוסמים)

---

### 6.2 משפחה עם 0 תשלומים
**תרחיש:** משפחה פעילה כבר שנה אבל אף פעם לא קיבלה תשלום

**טיפול:**
- אינדיקטור ויזואלי בדשבורד (רקע אדום בהיר)
- הצעה: כפתור "שלח תזכורת" בתוך התיק

---

### 6.3 תשלום בוטל אחרי ייצוא MASAV
**תרחיש:** תשלום כבר יוצא ל-MASAV, אבל מזכירה מוחקת אותו

**טיפול:**
- חסימה: "❌ לא ניתן למחוק תשלום שכבר יוצא להעברה"
- צריך לבטל דרך מודול העברות

---

### 6.4 משפחה סגורה עם תשלומים עתידיים
**תרחיש:** תיק נסגר, אבל יש תשלומים מתוכננים לחודשים הבאים (status = 'pending')

**טיפול:**
- אזהרה בעת סגירה
- תשלומים נשארים ב-DB (לא נמחקים)
- לא יופיעו בדשבורד אבל יופיעו בהעברות

---

### 6.5 שליחת מייל למשפחה ללא כתובת
**תרחיש:** משפחה פעילה אבל שדה `contact_email` ריק/NULL

**טיפול:**
- דילוג אוטומטי
- הצגת אזהרה: "⚠️ משפחת X ללא כתובת מייל - דולגים"
- רישום ב-`email_logs` עם `status = 'skipped'`

---

### 6.6 תקרה של 720 ₪ משתנה
**תרחיש:** העמותה מחליטה להעלות/להוריד את התקרה ל-800 ₪

**טיפול:**
- שדה בהגדרות מערכת: `cleaning_monthly_cap`
- הקוד קורא מההגדרות (לא קבוע hardcoded)
- תשלומים ישנים נשארים כמו שהם (לא מתעדכנים רטרואקטיבית)

---

## 7. אינטגרציה עם מודולים קיימים

### 7.1 מודול העברות

**נתיב:** `/transfers`

**טאבים:**
```
/transfers
├── טאב "הכל" ← חתונות + ילדים חולים מעורבים
├── טאב "חתונות" ← רק wedding_transfer
└── טאב "ילדים חולים" ← רק cleaning_monthly
```

**שאילתה לטאב "ילדים חולים":**
```sql
SELECT p.*, c.family_name, c.child_name, bd.account_number
FROM payments p
JOIN cases c ON p.case_id = c.id
JOIN bank_details bd ON c.id = bd.case_id
WHERE p.payment_type = 'cleaning_monthly'
  AND p.status = 'pending'
ORDER BY p.payment_month DESC;
```

**עמודות בטבלה:**
- תאריך יצירה
- משפחה (שם)
- טלפון
- מספר תיק
- חודש תשלום
- סכום (₪)
- שם בעל החשבון
- בנק / סניף / חשבון
- פעולות (סימון לייצוא)

---

### 7.2 מודול מיילים

**API endpoint:** `/api/emails/send`

**פרמטרים:**
```json
{
  "recipients": [
    { "case_id": "uuid1", "email": "cohen@example.com", "family_name": "כהן" },
    { "case_id": "uuid2", "email": "levi@example.com", "family_name": "לוי" }
  ],
  "template": "monthly_request",
  "language": "he" | "en",
  "custom_body": "..." // אופציונלי - עריכה ידנית
}
```

**Response:**
```json
{
  "success": true,
  "sent_count": 2,
  "failed": [],
  "sent_at": "2024-11-20T14:35:00Z"
}
```

---

## 8. הגדרות מערכת

### 8.1 תקרת תשלום חודשי

**שדה:** `settings.cleaning_monthly_cap`
**ערך ברירת מחדל:** 720
**ממשק ניהול:** `/settings` (דף הגדרות מערכת)

**Layout:**
```
┌────────────────────────────────────────────────────────────┐
│ הגדרות מערכת                                               │
├────────────────────────────────────────────────────────────┤
│                                                            │
│ 🧹 ילדים חולים - תקרת תשלום חודשי                          │
│                                                            │
│  סכום מקסימלי לחודש (₪): [720____]                         │
│                                                            │
│  [💾 שמור שינויים]                                         │
│                                                            │
│  ⚠️ שים לב: שינוי התקרה ישפיע רק על תשלומים חדשים          │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### 8.2 תבניות מיילים

**שדות:**
- `email_templates.monthly_request_he` (עברית)
- `email_templates.monthly_request_en` (אנגלית)

**ממשק עריכה:** `/settings/email-templates`

---

## 9. Data Model

### 9.1 שדות חדשים ב-`cases`

```sql
-- אין צורך בשדות חדשים - הכל קיים במודל המקורי
-- רק וידוא שהשדות הבאים מאוכלסים:
- family_name VARCHAR(100)
- child_name VARCHAR(100)
- parent1_name VARCHAR(100)
- parent2_name VARCHAR(100)
- start_date DATE
- end_date DATE (NULL אם פעיל)
- end_reason VARCHAR(100) ('healed' | 'deceased' | 'other')
- end_reason_notes TEXT (למקרה של 'other')
```

### 9.2 `payments` - חשוב!

```sql
-- וידוא שיש:
payment_type = 'cleaning_monthly'
payment_month DATE  -- יום 1 בחודש (2024-11-01)
amount_ils NUMERIC(10, 2)
status = 'pending' | 'transferred' | 'cancelled'
created_at TIMESTAMP
```

### 9.3 `email_logs`

```sql
-- וידוא שיש:
email_type = 'monthly_request'
case_id UUID
recipient_email VARCHAR(255)
subject TEXT
sent_at TIMESTAMP
status = 'sent' | 'failed' | 'skipped'
```

### 9.4 טבלה חדשה: `settings` (אם לא קיימת)

```sql
CREATE TABLE settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  key VARCHAR(100) UNIQUE NOT NULL,
  value TEXT NOT NULL,
  description TEXT,
  updated_at TIMESTAMP DEFAULT NOW()
);

INSERT INTO settings (key, value, description) VALUES
  ('cleaning_monthly_cap', '720', 'תקרת תשלום חודשי לילדים חולים (₪)');
```

---

## 10. סיכום קריטריוני הצלחה

### ✅ Must Have (גרסה 1.0)

- [x] דשבורד משפחות פעילות עם טבלה + סינונים
- [x] מסך תיק עם 2 טאבים (פרטים + תשלומים)
- [x] הזנת תשלום חודשי בודד + העברה למודול העברות
- [x] הזנה מהירה למספר משפחות
- [x] סגירת תיק עם סיבות
- [x] פתיחה מחדש של תיק
- [x] דשבורד משפחות לא פעילות
- [x] שליחת מיילים חודשיים (עברית + אנגלית)
- [x] אינדיקטור ויזואלי למשפחות ללא תשלום (מ-15 לחודש)
- [x] אינטגרציה עם מודול העברות (טאב נפרד)

### 🎯 Nice to Have (גרסה 1.1)

- [ ] תזכורות אוטומטיות (cron job)
- [ ] דוח חודשי אוטומטי ל-Excel
- [ ] גרפים וסטטיסטיקות מתקדמות
- [ ] ייצוא למערכת חשבונאות
- [ ] תמיכה בשפות נוספות (אידיש, רוסית)
- [ ] SMS notifications
- [ ] טופס דיווח אונליין להורים (במקום מייל)

---

## 11. נספחים

### 11.1 Wireframes ASCII

#### דשבורד משפחות
```
+----------------------------------------------------------+
| תיקים                           [חיפוש...] [סינון ▼]     |
| [טאב: חתונות] [טאב: ילדים חולים*]                       |
+----------------------------------------------------------+
|                                                          |
|  [➕ הזנה מהירה]              [📋 משפחות לא פעילות]      |
|                                                          |
+----------------------------------------------------------+
| שם משפחה | שם ילד | התחלה | חודש נוכחי | סטטוס          |
+----------------------------------------------------------+
| כהן      | יוסי   | 01/24 | 720 ₪      | ✅ הועבר        |
| לוי      | שרה    | 03/24 | -          | ⏳ ממתין [אדום] |
+----------------------------------------------------------+
```

#### מסך תיק - טאב תשלומים
```
+----------------------------------------------------------+
| תיק #2451 - משפחת כהן              סטטוס: [פעיל ▼]       |
| [טאב: פרטים] [טאב: תשלומים*]                             |
+----------------------------------------------------------+
| הזנת תשלום חדש:                                          |
|  חודש: [נובמבר ▼]  שנה: [2024 ▼]                        |
|  סכום: [______]₪   הערות: [____________]                |
|  [💾 שמור והעבר לתשלום]                                  |
+----------------------------------------------------------+
| היסטוריה:                                                |
| נובמבר 2024 | 720₪ | 05/11/24 | ✅ הועבר | [🗑️][✏️]      |
| אוקטובר 2024 | 650₪ | 02/10/24 | ⏳ ממתין | [🗑️][✏️]      |
+----------------------------------------------------------+
```

---

**סיום מסמך אפיון**

---

**אישורים:**

| תפקיד | שם | תאריך | חתימה |
|-------|-----|-------|-------|
| **Product Owner** | _______ | ______ | ______ |
| **Tech Lead** | _______ | ______ | ______ |

**גרסה:** 1.0
**תאריך:** 15/11/2024
**סטטוס:** ממתין לאישור
